<!DOCTYPE html>
<!--
This is a starter template page. Use this page to start your new project from
scratch. This page gets rid of all links and provides the needed markup only.
-->
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>{$sitetitle}</title>
	<!-- Tell the browser to be responsive to screen width -->
	<meta
	content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
	name="viewport">
	<!-- Bootstrap 3.3.6 -->
	<load href="__PUBLIC__/bootstrap/css/bootstrap.min.css" />
	<!-- Font Awesome -->
	<load href="__PUBLIC__/plugins/font-awesome/css/font-awesome.min.css" />
	<!-- Ionicons -->
	<load href="__PUBLIC__/plugins/other/ionicons.min.css" />
	<!-- Select2 -->
	<load href="__PUBLIC__/plugins/select2/select2.min.css" />
	<!-- bootstrap slider -->
	<load href="__PUBLIC__/plugins/bootstrap-slider/slider.css" />
	<!-- layui -->
	<load href="__PUBLIC__/plugins/layui/css/layui.css" />
	<!-- 最下面 -->
	<!-- Theme style -->
	<load href="__PUBLIC__/dist/css/admincore.css" />
	<!-- AdminLTE Skins. We have chosen the skin-blue for this starter
        page. However, you can choose any other skin. Make sure you
        apply the skin class to the body tag so the changes take effect.
  -->
	<load href="__PUBLIC__/dist/css/skins/skin-blue.min.css" />
	<!-- private css -->
	<load href="__PUBLIC__/jk/css/style.css" />
	<style type="text/css">.adv{display: none;}</style>
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	<!--[if lt IE 9]>
	<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
	<![endif]-->
	<script type="text/javascript">var rooturl = "__APP__";</script>
</head>

<body class="hold-transition skin-blue sidebar-mini ">
	<div class="wrapper">

		<!-- Main Header -->
		<header class="main-header">

			<!-- Logo -->
			<include file="Public/logo" />

			<!-- Header Navbar -->
			<nav class="navbar navbar-static-top" role="navigation">
				<!-- Sidebar toggle button-->
				<a href="#" class="sidebar-toggle" data-toggle="offcanvas"
					role="button">
					<span class="sr-only">Toggle navigation</span>
				</a>

				<!-- 上方导航栏 START -->
				<include file="Public/top_nav" />
				<!-- 上方导航栏 END -->

				<!-- Navbar Right Menu -->
				<include file="Public/top_right_menu" />
				<!-- Navbar Right Menu end -->
			</nav>
		</header>
		<!-- Left side column. contains the logo and sidebar -->
		<aside class="main-sidebar">

			<!-- sidebar: style can be found in sidebar.less -->
			<section class="sidebar">

				<!-- Sidebar user panel (optional) -->

				<!-- search form (Optional) -->

				<!-- /.search form -->

				<!-- Sidebar Menu -->
				<include file="Public/task_sidebar" />
				<!-- /.sidebar-menu -->
			</section>
			<!-- /.sidebar -->
		</aside>

		<!-- Content Wrapper. Contains page content -->
		<div class="content-wrapper">
			<!-- Content Header (Page header) -->
			<section class="content-header">
				<h1>创建任务</h1>
				<ol class="breadcrumb">
					<li>
						<a href="#"> <i class="fa fa-dashboard"></i>
							Level
						</a>
					</li>
					<li class="active">Here</li>
				</ol>
			</section>

			<!-- Main content -->
			<section class="content">
				<!-- Your Page Content Here -->
				<div class="row">
					<div class="col-md-1"></div>
					<div class="col-md-10">
						<!-- Horizontal Form -->
						<div class="box box-info">
							<div class="box-header with-border">
								<h3 class="box-title">TCP监控任务设置</h3>
							</div>
							<!-- /.box-header -->
							<!-- form start -->
							<form action="__APP__/Task/tcptaskadd" class="form-horizontal"  method="post" id="form1">
								<div id="hiddens">
									<input type="hidden" name="mids" value="{$task.mids}">
									<input type="hidden" name="tid" value="{$task.id}">
									<input type="hidden" name="update" value="{$update}">
									<input type="hidden" name="adv" value="0">
									<input type="hidden" name="alarm_num" value="0"></div>
								<div class="box-body">
									<div class="form-group">
										<label for="input1" class="col-sm-2 control-label">任务名称：</label>

										<div class="col-sm-10">
											<input type="text" name="title" class="form-control" id="input1" placeholder="任务名称" value="{$task.title}"></div>
									</div>
									<div class="form-group">
										<label for="input2" class="col-sm-2 control-label">tcp监控地址：</label>

										<div class="col-sm-10">
											<input type="text" name="target" class="form-control" id="input2" placeholder="http监控地址" value="{$taskdetail.target}"></div>
									</div>
									<div class="form-group">
										<label for="input2" class="col-sm-2 control-label">tcp端口：</label>

										<div class="col-sm-10">
											<input type="text" name="port" class="form-control" id="input2" placeholder="http监控地址" value="{$taskdetail.port}"></div>
									</div>
									<div class="form-group">
										<label for="input2" class="col-sm-2 control-label">监控点：</label>

										<div class="col-sm-1">
											<button type="button" class="btn btn-info pull-left" onclick="smp();">配置</button>
										</div>
										<div class="col-sm-9" id="midinfo">已配置0个监控点</div>
									</div>
									<!-- 									<div class="form-group">
									<label class="col-sm-2 control-label">监控点</label>
									<div class="col-sm-10">
										<select class="form-control select2 mids" name="mids[]" multiple="multiple" data-placeholder="点击选择监控点" style="width: 100%;">
											<foreach name="mps" item="vo" >
												<option value="{$vo.id}" <if condition="($vo.isdefault eq 1)">selected=""</if>
												>{$vo.title}
											</option>
										</foreach>
									</select>
								</div>
							</div>
							-->
							<div class="form-group">
								<label class="col-sm-2 control-label">标签</label>
								<div class="col-sm-8">
									<select class="form-control select2 labels"
											multiple="multiple" name="labels[]" data-placeholder="点击选择标签" style="width: 100%;">
										<option value="1">标签1</option>
										<option value="2">标签2</option>
										<option value="3">标签3</option>
									</select>
								</div>
								<div class="col-sm-2">
									<button type="button" class="btn btn-info pull-left">添加</button>
								</div>
							</div>
							<div class="form-group">
								<label for="ex1" class="col-sm-2 control-label">监控频率：</label>
								<div class="col-sm-4">
									<input id="ex1" name="frequency" data-slider-id='blue' type="text" data-slider-min="1" data-slider-max="60" data-slider-step="1" data-slider-value="{$task.frequency|default=5}"/>
								</div>
								<div class="col-sm-6">
									<span class="ext1v">{$task.frequency|default=5}分钟</span>
								</div>
							</div>

							<div class="form-group " >
								<div class="col-sm-12">
									<div class="divider15"></div>
								</div>
								<label for="input4" class="col-sm-2 control-label" style="font-size: 16px;">告警设置</label>
								<div class="col-sm-10">
									<button type="button" class="btn btn-info" data-toggle="modal" data-target="#addalarm">增加告警策略</button>
								</div>
							</div>
							<div class="form-group " >
								<div class="col-sm-1"></div>
								<div class="col-sm-10">
									<table id="alarm_table" class="table table-bordered">
										<tr>
											<th>指标</th>
											<th>条件</th>
											<th>预警值</th>
											<th>连续告警次数</th>
											<th style="width: 40px">状态</th>
											<th>操作</th>
										</tr>
										<foreach name="triggers" item="vo" >
											<tr id="atrx{$vo.id}">
												<td>{$vo.comment}</td>
												<td>
													<switch name="vo.operator_type" >
														<case value="gt">大于</case>
														<case value="lt">小于</case>
														<case value="eq">等于</case>
													</switch>
												</td>
												<td>{$vo.threshold}</td>
												<td>{$vo.data_times}</td>
												<td>
													<span class="badge bg-green">开启</span>
												</td>
												<td>
													<div class="btn-group">
														<button type="button" class="btn btn-xs btn-info">修改</button>
														<button type="button" class="btn btn-xs btn-info" onclick="delalarm({$vo.id},1)">删除</button>
													</div>
												</td>
											</tr>
										</foreach>
									</table>
								</div>
								<div class="col-sm-1"></div>
							</div>
<!-- 							<div class="form-group">
								<label for="input3" class="col-sm-2 control-label"></label>
								<div class="col-sm-10">
									<button id="" onclick="adv_show();" type="button" class="btn btn-info pull-left">高级选项</button>
								</div>
							</div> -->
						</div>
						<!-- /.box-body -->
						<div class="box-footer">
							<button type="button" class="btn btn-info pull-right" onclick="savefrom();">保存</button>
						</div>
						<!-- /.box-footer -->
					</form>
				</div>
			</div>
			<div class="col-md-1"></div>
		</div>

		<!-- 添加监控点模态框 -->

		<include file="Public/mpoint_add_div" />

		<!-- 添加监控点模态框 END -->

		<!-- 告警模态框（Modal） -->
		<div class="modal fade" id="addalarm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content" >
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
						<h4 class="modal-title" id="myModalLabel">增加告警策略</h4>
					</div>
					<div class="modal-body">
						<!-- modal start -->
						<form class="form-horizontal" role="form" id="form2">
							<div class="form-group">
								<label for="firstname" class="col-sm-3 control-label">监控指标名称：</label>
								<div class="col-sm-9">
									<select class="form-control" id="item_id">
										<foreach name="alarmitems" item="vo" >
											<option value="{$vo.itemid}">{$vo.comment}</option>
										</foreach>
									</select>
								</div>
							</div>
							<div class="form-group">
								<div class="col-sm-1 alarmv1"></div>
								<div class="col-sm-3 alarmv1">
									<select class="form-control" id="op1">
										<option value="gt">大于</option>
										<option value="lt">小于</option>
										<option value="eq">等于</option>
									</select>
								</div>
								<div class="col-sm-5 alarmv1">
									<input type="number" id="threshold1" class="form-control" id="lastname" placeholder=""></div>
								<div class="col-sm-3 alarmv1">
									<select class="form-control" id="unit">
										<option value="ms">毫秒</option>
										<option value="s">秒</option>
									</select>
								</div>
								<div class="col-sm-3 alarmv2"></div>
								<div class="col-sm-3 alarmv2">
									<select class="form-control" id="op2">
										<option value="gt">大于</option>
										<option value="lt">小于</option>
										<option value="eq">等于</option>
									</select>
								</div>
								<div class="col-sm-6 alarmv2">
									<input type="number" id="threshold2" class="form-control" id="lastname" placeholder="百分比"></div>

							</div>
							<div class="form-group">
								<label for="firstname" class="col-sm-3 control-label">数值计算方式：</label>
								<div class="col-sm-9">
									<select class="form-control" id="calc">
										<option value="0">所有监测点平均</option>
										<option value="1">所选监控点平均</option>
									</select>
								</div>
							</div>
							<div class="form-group amidsdiv">
								<label for="firstname" class="col-sm-3 control-label">监控点选择：</label>
								<div class="col-sm-9 ">
									<select class="form-control select2 amids"
											multiple="multiple" name="amids[]" data-placeholder="点击选择标签" style="width: 100%;">
										<option value="1">标签1</option>
										<option value="2">标签2</option>
										<option value="3">标签3</option>
									</select>
								</div>
							</div>
							<div class="form-group">
								<label for="firstname" class="col-sm-3 control-label">连续告警次数：</label>
								<div class="col-sm-9">
									<select class="form-control" id="atimes">
										<option value="1">1</option>
										<option value="2">2</option>
										<option value="3">3</option>
									</select>
								</div>
							</div>
						</form>
						<!-- modal end -->
					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
						<button type="button" class="btn btn-primary" onclick="savealarm();">提交保存</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal -->
		</div>
		<!-- 告警模态框（Modal）END -->

	</section>
	<!-- /.content -->
</div>
<!-- /.content-wrapper -->

<!-- Main Footer -->
<include file="Public/main_footer" />

<!-- Control Sidebar -->

<!-- /.control-sidebar -->
<!-- Add the sidebar's background. This div must be placed
       immediately after the control sidebar -->
<div class="control-sidebar-bg"></div>
</div>
<!-- ./wrapper -->

<!-- REQUIRED JS SCRIPTS -->

<!-- jQuery 2.2.3 -->
<load href="__PUBLIC__/plugins/jQuery/jquery-2.2.3.min.js" />
<!-- Bootstrap 3.3.6 -->
<load href="__PUBLIC__/bootstrap/js/bootstrap.min.js" />
<!-- Select2 -->
<load href="__PUBLIC__/plugins/select2/select2.full.min.js" />
<!-- Bootstrap slider -->
<load href="__PUBLIC__/plugins/bootstrap-slider/bootstrap-slider.js" />
<!-- echarts -->
<load href="__PUBLIC__/plugins/echarts/echarts.js" />
<load href="__PUBLIC__/plugins/echarts/china.js" />
<!-- layui -->
<load href="__PUBLIC__/plugins/layui/layui.js" />
<!-- AdminLTE App -->
<load href="__PUBLIC__/dist/js/app.min.js" />
<!-- private JS -->
<load href="__PUBLIC__/jk/js/task/mpoint.js" />
<!-- <load href="__PUBLIC__/jk/js/http.js" />
-->
<!-- Optionally, you can add Slimscroll and FastClick plugins.
     Both of these plugins are recommended to enhance the
     user experience. Slimscroll is required when using the
     fixed layout. -->
<script type="text/javascript">
	var is_adv = {$task.isadv|default=0};
	/* SELECT2 */
	$(".select2").select2();

	/* BOOTSTRAP SLIDER */
	$('#ex1').slider({
		formatter: function(value) {
			return value + '分钟';
		}
	});
	$('#ex1').on("slide", function(slideEvt) {
		$(".ext1v").text((slideEvt.value + '分钟'));
	});
	
	/* 操作 */
	function adv_show() {
		var adv=$("input[name='adv']").val();
		if(adv == 0){
			$("input[name='adv']").val(1);
			$('.adv').css("display", "block");
			if($("input[name='reqtype']:checked").val() == 'head'){
				$('.adv_post').css('display', 'none');
				$('.adv_m1').css('display', 'none');
				$('.adv_m2').css('display', 'none');
			}else if($("input[name='reqtype']:checked").val() == 'get'){
				$('.adv_post').css('display', 'none');
				//$('.adv_m1').css('display', 'block');
				//$('.adv_m2').css('display', 'block');
			}
		}else{
			$("input[name='adv']").val(0);
			$('.adv').css("display", "none");
		}
	}


	$("input[name='reqtype']").click(function(){
		var m = $(this).val();
		var mp = $('.adv_post');
		var m1 = $('.adv_m1');
		var m2 = $('.adv_m2');
		if(m=='get'){
			mp.css('display', 'none');
			m1.css('display', 'block');
			m2.css('display', 'block');
		}else if(m == 'post'){
			mp.css('display', 'block');
			m1.css('display', 'block');
			m2.css('display', 'block');
		}else if(m == 'head'){
			mp.css('display', 'none');
			m1.css('display', 'none');
			m2.css('display', 'none');
		}
		//console.log($(this).val());
	});

	$('.amidsdiv').css('display', 'none');
	$("#calc").change(function(){
		var aitem = $("#calc").find("option:selected").val();
		var amidsdiv = $(".amidsdiv");
		if(aitem==1){

			$('.amids').empty();

			for (var i = 0; i < pointlist.length; i++) {

				var v1=pointlist[i][0];
				var v2=pointlist[i][1];
		    	var html="<option value=\""+v1+"\">"+v2+"</option>";
		    	$('.amids').append(html);

			}


			// $(".mids").find("option:selected").each(function(){
			// //console.log($(this).text());
		 //    //console.log($(this).val());
		 //    var html="<option value=\""+$(this).val()+"\">"+$(this).text()+"</option>";
		 //    $('.amids').append(html);
		 //  	});

			amidsdiv.css('display', 'block');


		}else{
			$('.amids').empty();
			amidsdiv.css('display', 'none');
		}

	});


	$('.alarmv2').css('display', 'none');
	$("#item_id").change(function(){
		var aitem=$("#item_id").find("option:selected").text();
		var a1 = $('.alarmv1');
		var a2 = $('.alarmv2');
		if(aitem=='当日可用率' || aitem=='当前丢包率'){
			a1.css('display', 'none');
			a2.css('display', 'block');
		}else if(aitem == '当前响应时间'){
			a2.css('display', 'none');
			a1.css('display', 'block');
		}
	});
	

	//原外置js
	var alarmlist = new Array();
	function savealarm() {
		var item_text = $("#item_id option:selected").text();
		var item_id = $("#item_id option:selected").val();
		var op = $("#op1 option:selected").val();
		var op_text = $("#op1 option:selected").text();
		var threshold = $("#threshold1").val();
		var unit = $("#unit option:selected").val();
		var calc = $("#calc option:selected").val();
		var atimes = $("#atimes option:selected").val();
		var amids ="";

		var aitem = $("#item_id").find("option:selected").text();
		if (aitem=='当日可用率' || aitem=='当前丢包率') {
			op = $("#op2 option:selected").val();
			op_text = $("#op2 option:selected").text();
			threshold = $("#threshold2").val();
			unit = '%';
		}

		if(calc == 1){
			var n = 0;
			$(".amids").find("option:selected").each(function(){
				//console.log($(this).text());
			    //console.log($(this).val());
			    if(n>0){
			    	amids = amids + ";";
			    }
			    amids = amids + $(this).val();
			    n++;
			});
		}
		var index = alarmlist.length;
		var temp = new Array();
		temp[0] = item_id;
		temp[1] = op;
		temp[2] = threshold;
		temp[3] = unit;
		temp[4] = calc;
		temp[5] = atimes;
		temp[6] = item_text;
		temp[7] = op_text;
		temp[8] = amids;


		alarmlist[index] = temp;

		$('#addalarm').modal('hide');
		$('#addalarm').modal('hide');
		var tr = createtr(temp,index);
		$('#alarm_table').append(tr);
		//console.log("alarmlist");
		//console.log(alarmlist);
		$(".amidsdiv").css('display', 'none');
		$("#form2")[0].reset();
	}

	function savefrom() {
		var num = alarmlist.length;
		$("input[name='alarm_num']").val(alarmlist.length);
		for (var i = 0; i < alarmlist.length; i++) {
			var temp = alarmlist[i];
			var name = "a" + i;
			var input = "<input type=\"hidden\" name=\"" + name + "\" value=\"0\"></div>";
			$('#hiddens').append(input);
			var s = "input[name='" + name + "']";
			$(s).val(temp);
		}
		//验证表单
		var title=$("input[name='title']").val(); 
		var target=$("input[name='target']").val();
		var port=$("input[name='port']").val();
		//var username=$("input[name='username']").val();
		//var password=$("input[name='password']").val();

		if(title == ''){
			layer.msg('任务名称不能为空');
		}else if(target == ''){
		    layer.msg('监控地址不能为空');
		}else if(port == ''){
			layer.msg('端口号不能为空');
		}else if(pointlist.length == 0){
			layer.msg('监控点不能为空');
		}else{
			var mids = "";
			for (var i = 0; i < pointlist.length; i++) {
				if(i > 0 ){
					mids = mids + ",:" + pointlist[i][0] + ":";
				}else{
					mids = mids + ":" + pointlist[i][0] + ":";
				}
			}
			$("input[name='mids']").val(mids);
			$('#form1')[0].submit();
		}

		
	}

	function createtr(arr,index) {
		var html = "<tr id=\"atr"+index+"\">";
		html += "<td>" + arr[6] + "</td><td>" + arr[7] + "</td><td>" + arr[2] + arr[3] + "</td><td>" + arr[5] + "</td><td><span class=\"badge bg-green\">开启</span></td><td><div class=\"btn-group\"><button type=\"button\" class=\"btn btn-xs btn-info\" onclick=\"\">修改</button><button type=\"button\" class=\"btn btn-xs btn-info\" onclick=\"delalarm("+index+","+"0"+");\">删除</button></div></td>";
		html += "</tr>";
		return html;
	}

	function delalarm(index,type){
		if(type==0){
			//不用AJAX
			console.log("DEL:"+index);
			alarmlist[index]="del";
			$(("#atr"+index)).remove();
		}else{
			var delurl = '__APP__/Task/delalarm';
			$.post(delurl, {
					aid: index
				},
				function(data, status) {
					if (data == 1) {
						alert('操作成功');
						$(("#atrx"+index)).remove();
					} else {
						alert('操作失败');
					}
				});
		}
	}

	if(is_adv==1){
		adv_show();	
	}
	

	</script>
</body>
</html>